---
title: "SURE 2023 - Football/Soccer"
output: html_document
date: "2023-06-21"
---
```{r, warning=FALSE}
# install necessary packages
library(devtools)
library(StatsBombR)
library(worldfootballR)
library(dplyr)
library(tidyr)
library(lubridate)
library(ggplot2)
library(FNN)
library(tidymodels)
library(aod)
library(nnet)
```

```{r}
#fotmob data
Comp <- FreeCompetitions()
Matches <- FreeMatches(Comp)
fotmob_matches <- fotmob_get_matches_by_date(date = c("20210925"))
fotmob_matches <- c(3609994, 3610132)
match_info <- fotmob_get_match_info(fotmob_matches)
match_details_first <- fotmob_get_match_details(c(3609981))
```

```{r}
#betting and footystat data
bettingPL2018 <- read.csv("E0 (1).csv")
basicInfoPL2018 <- read.csv("england-premier-league-matches-2018-to-2019-stats.csv")
team_data <- read.csv("teams.csv")
team_data_2 <- read.csv("teams2.csv")
players_data <- read.csv("players.csv")
```


```{r}
#match team names
bettingPL2018$HomeTeam <- 
  stri_replace_all_regex(bettingPL2018$HomeTeam,
                         pattern = c("Man United", "Bournemouth",
                                     "Huddersfield", "Newcastle",
                                     "Wolves", "Cardiff", "Leicester",
                                     "Tottenham", "West Ham", "Brighton",
                                     "Man City"),
                         replacement = c("Manchester United", 
                                         "AFC Bournemouth", 
                                         "Huddersfield Town",
                                         "Newcastle United",
                                         "Wolverhampton Wanderers",
                                         "Cardiff City", 
                                         "Leicester City", 
                                         "Tottenham Hotspur",
                                         "West Ham United", 
                                         "Brighton & Hove Albion",
                                         "Manchester City"),
                         vectorize = FALSE)

bettingPL2018$AwayTeam <- 
  stri_replace_all_regex(bettingPL2018$AwayTeam,
                         pattern = c("Man United", "Bournemouth",
                                     "Huddersfield", "Newcastle",
                                     "Wolves", "Cardiff", "Leicester",
                                     "Tottenham", "West Ham", "Brighton",
                                     "Man City"),
                         replacement = c("Manchester United", 
                                         "AFC Bournemouth", 
                                         "Huddersfield Town",
                                         "Newcastle United",
                                         "Wolverhampton Wanderers",
                                         "Cardiff City", 
                                         "Leicester City", 
                                         "Tottenham Hotspur",
                                         "West Ham United", 
                                         "Brighton & Hove Albion",
                                         "Manchester City"),
                         vectorize = FALSE)
```


```{r, warning= FALSE}
#create new variable to match with and merge
bettingPL2018 <- bettingPL2018 %>% 
  mutate(Info = paste(HomeTeam, " ", AwayTeam, "-", Date))

basicInfoPL2018 <- basicInfoPL2018 %>% mutate(datetime = as_datetime(timestamp),
                           date = as_date(datetime),
                           day = day(date),
                           month = month(date),
                           year = year(date),
                           dmy = str_c(day, month, year, sep = "/"),
                           date = format(date, "%d/%m/%Y"))


basicInfoPL2018 <- basicInfoPL2018 %>%
  mutate(Date = make_date(date_GMT),
         Info = paste(home_team_name, " ", away_team_name, "-", date))

bettingBasicPL2018 <- left_join(bettingPL2018, basicInfoPL2018, 
                                       by = "Info")

```


```{r}
#Rename
bettingBasicPL2018 <- bettingBasicPL2018 %>% 
  rename(Home_goals = FTHG, Away_goals = FTAG, Halftime_home_goals = HTHG, 
         Halftime_away_goals = HTAG, Home_shots = HS, Away_shots = AS, 
         Home_shots_on_target = HST, Away_shots_on_target = AST ,Home_fouls = HF, 
         Home_cards =  HC,Away_cards = AC, Home_yellows = HY, Away_yellows = AY , 
         Home_reds = HR, Away_reds = AR, Full_time_result = FTR, Half_time_result = HTR)

# FIFA Data

FIFA_players <- read.csv("players_18.csv")
```


```{r}
# create new expected win variable
bettingBasicPL2018 <- bettingBasicPL2018 %>% 
  mutate(expect_win = ifelse(((odds_ft_home_team_win < odds_ft_draw) & (odds_ft_home_team_win < odds_ft_away_team_win)), "expected home wins", 
                        ifelse((odds_ft_draw < odds_ft_home_team_win) & (odds_ft_draw < odds_ft_away_team_win), "expected draw", "expected away win")))
```

```{r}
#mosiac plot to compare expected and actual win rate
mosaicplot(table(bettingBasicPL2018$Full_time_result, bettingBasicPL2018$expect_win),
shade = TRUE, main = "Relationship between expected win and actual win?")
```

```{r}
# bar graph for referral
bettingBasicPL2018 %>%
  ggplot(aes(x = Full_time_result, fill = expect_win)) +
  geom_bar() + theme_bw()
```

```{r}
bettingBasicPL2018 <- bettingBasicPL2018 %>% 
  mutate(result = ifelse((Full_time_result == "H") , 0, 
                        ifelse((Full_time_result == "A") , 2, 1)))
set.seed(50) 
train_ids <- sample(1:nrow(bettingBasicPL2018),                    
                                 ceiling(0.75 * nrow(bettingBasicPL2018)))
train_pl <- bettingBasicPL2018[train_ids, ] 
test_pl <- bettingBasicPL2018[-train_ids, ]
# separate predictors and response, again 
train_x <- dplyr::select(train_pl, Home_shots, home_team_possession, home_ppg) 
train_y <- train_pl$result 
test_x <- dplyr::select(test_pl, Home_shots, home_team_possession, home_ppg) 
test_y <- test_pl$result
```

```{r}
one_nn_train_preds <- knn(train = train_x, test = train_x, cl = train_y, k = 1, algorithm = "brute")
mean(train_y == one_nn_train_preds)

one_nn_train_preds <- knn(train = train_x, test = test_x, cl = train_y, k = 1, algorithm = "brute")
mean(test_y == one_nn_train_preds)
```

```{r}
errs_train <- rep(0, 12) 
errs_test <- rep(0, 12) 
k_vals <- 1:12 
for(k in k_vals) {  
  train_preds <- knn(train = train_x, test = train_x, cl = train_y, k = k, algorithm = "brute") 
  errs_train[k] <- mean(!train_y == train_preds)  
  test_preds <- knn(train = train_x, test = test_x, cl = train_y, k = k, algorithm = "brute")  
  errs_test[k] <- mean(!test_y == test_preds)
}
```


```{r}
errors <- bind_cols(train_err = errs_train,                  
                    test_err = errs_test,                   
                    k = k_vals)
errors %>%   pivot_longer(c(train_err, test_err),               
                          names_to = "err_type") %>%   
  ggplot(aes(x = k, y = value,             
             color = err_type)) + 
  geom_point() +  
  geom_line() +  
  labs(y = "Misclassification Rate",       
       color = "Type of error") + 
  theme_bw()
```

```{r}
knn_reg_mod <- nearest_neighbor(
  mode = "classification",
  engine = "kknn",
  neighbors = 5,
  weight_func = NULL,
  dist_power = NULL
)

#result_knn <- knn_reg_mod %>% 
 # fit(result ~ Home_shots + home_ppg + home_team_possession, data= bettingBasicPL2018)

#result_knn
```

```{r}
ggplot(bettingBasicPL2018) +
  geom_point(aes(x = Home_shots,
                 y= home_team_possession,
                 color = as.factor(result)
            ),
            size = 2) +
  theme_bw()

```


```{r}


  #firstlm <- glm(as.factor(Full_time_result) ~ Home_shots + home_ppg + home_team_possession, family = "poisson", data= bettingBasicPL2018)
```


```{r}
bettingBasicPL2018 <-  bettingBasicPL2018 %>% 
  mutate(expect_bet_H = 1/B365H,
         expect_bet_A = 1/B365A,
         expect_bet_D = 1/B365D,
         marginal_prob_total = expect_bet_H + expect_bet_D + expect_bet_A,
         percent_H = expect_bet_H *100/marginal_prob_total,
         percent_D = expect_bet_D *100/marginal_prob_total,
         expect_point_H = percent_H * 3 + percent_D,
         Full_time_result_point =  ifelse((Full_time_result == "H"), 3, 
                        ifelse((Full_time_result == "D"), 1, 0)))
  

```



```{r}
bettingBasicPL2018 %>% 
  ggplot(aes(x = Full_time_result,
             y = expect_point_H)) +
  geom_violin() +
  geom_boxplot(width = .2) +
  theme_bw()
  
```

```{r}
bettingBasicPL2018 %>% 
  ggplot(aes(
             x = expect_point_H)) +
  geom_histogram(alpha = .25, position = "identity") +
  facet_wrap(~ Full_time_result, nrow = 3)
```


```{r}
#linear model
expect_model <- multinom(as.factor(Full_time_result_point) ~ expect_point_H, data = bettingBasicPL2018)
summary(expect_model)
```
```{r}
z <- summary(expect_model)$coefficients/summary(expect_model)$standard.errors
p <- (1 - pnorm(abs(z), 0, 1)) * 2
p
```

```{r}
wald.test(b = coef(expect_model), Sigma = vcov(expect_model), Terms = 1)
```
```{r}
newdata1 <- with(bettingBasicPL2018, data.frame(expect_point_H = mean(expect_point_H), Full_time_result_point = factor("H", "A", "D")))
newdata1$rankP <- predict(expect_model, newdata = newdata1, type = "response")
newdata1
```

```{r}
#line-up for Jan 19, 2019 match of Arsenal-Chelsea
Ars_Che_2019Jan <- players_data %>% 
  filter(season == "2018/2019", Current.Club == c("Arsenal", "Chelsea")) %>% 
  mutate(starter_Jan19 = (ifelse(full_name %in% c("Kepa Arrizabalag",	"David Luiz",	"Cesar Azpilicueta",	"Marcos Alonso", "Antonio Rüdiger", "Mateo Kovačić", "Joringo", "N'Golo Kanté", "Willian", "Eden Hazard",	"Pedro Rodriguez", "Bernd Leno", "Sokratis Papastathopoulos",	"Laurent Koscielny",	"Sead Kolašinac",	"Hector Bellerin", "Aaron Ramsey", "Granit Xhaka", "Lucas Torreira", 	"Matteo Guendouzi",	"Pierre-Emerick Aubameyang",	"Alexandre Lacazette"), "Starter", "Other")))
```

